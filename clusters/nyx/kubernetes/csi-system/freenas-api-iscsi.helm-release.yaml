apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: freenas-api-iscsi
    namespace: csi-system
spec:
    interval: 5m
    chart:
        spec:
            chart: democratic-csi
            version: v1.9.4
            sourceRef:
                kind: HelmRepository
                name: democratic-csi
                namespace: flux-system
            interval: 5m
    install:
        createNamespace: true
        crds: CreateReplace
        remediation:
            retries: 3
    upgrade:
        crds: CreateReplace
        remediation:
            retries: 3
    values:
        driver: freenas-api-iscsi
        instance_id: null
        httpConnection:
            protocol: https
            host: 192.168.178.14
            port: 8443
            # use only 1 of apiKey or username/password
            # if both are present, apiKey is preferred
            # apiKey is only available starting in TrueNAS-12
            apiKey: ENC[AES256_GCM,data:sWCHE4KWcPqCi9FAoZgH/FUpxtd7jskgD1QifARwlvSxEr0zz+BKcXqmyR6SurFoj1llzJDmlfsQF4J8xz1xxmA2,iv:kBLRRLYpA/C1isgEKlqnGLgnGm5fy/M2qlLU61jAhDQ=,tag:Ll0RCQAHv1lQ11jLx2FhIw==,type:str]
            #username: root
            #password:
            allowInsecure: true
            # use apiVersion 2 for TrueNAS-12 and up (will work on 11.x in some scenarios as well)
            # leave unset for auto-detection
            apiVersion: 2
        zfs:
            # can be used to override defaults if necessary
            # the example below is useful for TrueNAS 12
            cli:
                sudoEnabled: true
            #
            #  leave paths unset for auto-detection
            #  paths:
            #    zfs: /usr/local/sbin/zfs
            #    zpool: /usr/local/sbin/zpool
            #    sudo: /usr/local/bin/sudo
            #    chroot: /usr/sbin/chroot
            # can be used to set arbitrary values on the dataset/zvol
            # can use handlebars templates with the parameters from the storage class/CO
            datasetProperties:
                org.freenas:description: '{{ parameters.[csi.storage.k8s.io/pvc/namespace] }}/{{ parameters.[csi.storage.k8s.io/pvc/name] }}'
            #  "org.freenas:test": "{{ parameters.foo }}"
            #  "org.freenas:test2": "some value"
            # total volume name (zvol/<datasetParentName>/<pvc name>) length cannot exceed 63 chars
            # https://www.ixsystems.com/documentation/freenas/11.2-U5/storage.html#zfs-zvol-config-opts-tab
            # standard volume naming overhead is 46 chars
            # datasetParentName should therefore be 17 chars or less when using TrueNAS 12 or below (SCALE and 13+ do not have the same limits)
            # for work-arounds see https://github.com/democratic-csi/democratic-csi/issues/54
            datasetParentName: chronos/nyx-iscsi-volumes
            # do NOT make datasetParentName and detachedSnapshotsDatasetParentName overlap
            # they may be siblings, but neither should be nested in the other
            # do NOT comment this option out even if you don't plan to use snapshots, just leave it with dummy value
            detachedSnapshotsDatasetParentName: chronos/nyx-iscsi-snapshots
            # "" (inherit), lz4, gzip-9, etc
            zvolCompression: ""
            # "" (inherit), on, off, verify
            zvolDedup: ""
            zvolEnableReservation: false
            # 512, 1K, 2K, 4K, 8K, 16K, 64K, 128K default is 16K
            zvolBlocksize: 128K
        iscsi:
            targetPortal: 192.168.178.14:3260
            # for multipath
            targetPortals: []
            # leave empty to omit usage of -I with iscsiadm
            interface: null
            # MUST ensure uniqueness
            # full iqn limit is 223 bytes, plan accordingly
            # default is "{{ name }}"
            nameTemplate: '{{ parameters.[csi.storage.k8s.io/pvc/namespace] }}-{{ parameters.[csi.storage.k8s.io/pvc/name] }}'
            #namePrefix: csi-
            #nameSuffix: "-clustera"
            # add as many as needed
            targetGroups:
                # get the correct ID from the "portal" section in the UI
                # https://github.com/democratic-csi/democratic-csi/issues/302
                # NOTE: the ID in the UI does NOT always match the ID in the DB, you must use the DB value
                - targetGroupPortalGroup: 1
                  # get the correct ID from the "initiators" section in the UI
                  targetGroupInitiatorGroup: 1
                  # None, CHAP, or CHAP Mutual
                  targetGroupAuthType: None
                  # get the correct ID from the "Authorized Access" section of the UI
                  # only required if using Chap
                  targetGroupAuthGroup: null
            #extentCommentTemplate: "{{ parameters.[csi.storage.k8s.io/pvc/namespace] }}/{{ parameters.[csi.storage.k8s.io/pvc/name] }}"
            extentInsecureTpc: true
            extentXenCompat: false
            extentDisablePhysicalBlocksize: true
            # 512, 1024, 2048, or 4096,
            extentBlocksize: 512
            # "" (let FreeNAS decide, currently defaults to SSD), Unknown, SSD, 5400, 7200, 10000, 15000
            extentRpm: "5400"
            # 0-100 (0 == ignore)
            extentAvailThreshold: 0
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1pee99j8wzwkgx98xcx7vqhj4ml2qh8farzanv07pmhrlr9x3uyxqp6dw8h
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBXY0JqT3JyT1pIdjBraXFY
            ajlZb3pzU0JlVStsbFgvMHdORldBWUJrRWhvCjhSa1ZTaFBtVXU5N053dHJsWnVa
            UW02ME5zQ0lSVVVSb1pOVjFYaXZqblEKLS0tIDVHakdTS08rQlJ6RTltd0lJSS9L
            NUt3bkxxemNicTlYdVV5Q0NWMTU2VXcK3bNMieqwu5KV0PCWc+bzXFHrhsGh6fOM
            OUtcZi6D/wOKD5TZuGOmZzX4lsrsx/IrUkBD64fLIO7TWsJ8EVoK8Q==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2024-08-06T14:40:15Z"
    mac: ENC[AES256_GCM,data:YFrAv6xb3+UmIkx+iog/Cw1AFdzHzXYce4y1aMTAb2X+JWjla0h3C1maKqLXcqPBY3MNnDYH7TJ9zkulyl/Np+6SCnI0Jw1HEjP6XeoYOju8MVkoef79xOZTs0Bji2ghkje85ZPfMkqkShajbWkrsUdEIRPltkBjD0AYfhqeRik=,iv:GBs2wEta2Kk0RMqQjVU+7PrBIPh/UN2pbObKuO60UJI=,tag:M0ZXJF7aKv9LzK9BtUmDHw==,type:str]
    pgp: []
    encrypted_regex: ^apiKey$
    version: 3.9.0
