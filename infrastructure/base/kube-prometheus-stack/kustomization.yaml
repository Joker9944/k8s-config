---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: kube-prometheus-stack

resources:
  - manifests/namespace.yaml
  - manifests/secret.yaml
  - flux/helm-repository.yaml
  - flux/helm-release.yaml

components:
  - ../../../components/common-kustomizeconfig
  - ../../../components/common-middlewares

replacements:

  - source:
      kind: HelmRelease
      name: kube-prometheus-stack
      fieldPath: metadata.namespace
    targets:
      - select:
          kind: HelmRelease
          name: kube-prometheus-stack
        fieldPaths:
          - spec.values.alertmanager.ingress.annotations.[traefik.ingress.kubernetes.io/router.middlewares]
          - spec.values.grafana.ingress.annotations.[traefik.ingress.kubernetes.io/router.middlewares]
          - spec.values.prometheus.ingress.annotations.[traefik.ingress.kubernetes.io/router.middlewares]
        options:
          delimiter: '-'
          index: 0
