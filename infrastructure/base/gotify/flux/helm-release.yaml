---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gotify
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 4.6.2
      interval: 30m
      sourceRef:
        kind: HelmRepository
        name: bjw-s

  values:
    global:
      alwaysAppendIdentifierToResourceName: true

    defaultPodOptions:
      securityContext:
        runAsUser: &PUID 568
        runAsGroup: &GUID 568
        runAsNonRoot: true
        fsGroup: *GUID
        fsGroupChangePolicy: OnRootMismatch
        seccompProfile:
          type: RuntimeDefault

    controllers:
      gotify:
        type: deployment

        containers:
          gotify:
            image:
              repository: ghcr.io/joker9944/gotify-custom
              tag: 2.8.0@sha256:9cfab7e072b4c745a4533fa25bdb09d379845a73fd06e2a877ce2a614601b921
            env:
              GOTIFY_SERVER_PORT: &port_http 8080
              GOTIFY_SERVER_KEEPALIVEPERIODSECONDS: 0
              GOTIFY_SERVER_LISTENADDR:
              GOTIFY_SERVER_SSL_ENABLED: false
              GOTIFY_SERVER_TRUSTEDPROXIES: "[10.244.0.0/16]"
              GOTIFY_SERVER_CORS_ALLOWORIGINS: "[gotify.vonarx.online]"
              GOTIFY_SERVER_STREAM_PINGPERIODSECONDS: 45
              GOTIFY_DATABASE_DIALECT: postgres
              GOTIFY_UPLOADEDIMAGESDIR: /data/images
              GOTIFY_PLUGINSDIR: /plugins
            envFrom:
              - secretRef:
                  name: gotify-default-user
              - secretRef:
                  name: gotify-custom-cnpg-connection
            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /health
                    port: *port_http
                  failureThreshold: 6
              readiness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /health
                    port: *port_http
              startup:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /health
                    port: *port_http
                  failureThreshold: 30
                  periodSeconds: 5
            resources:
              requests:
                cpu: 50m
                memory: 1Gi
              limits:
                memory: 2Gi
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                  - ALL

        initContainers:
          postgresql:
            image:
              repository: ghcr.io/joker9944/postgresql-client
              tag: 3.23.2@sha256:ae1c3883cd5864a77006a66c5ff44aad4615ac31f0b510a0960d4f7b42c944c1
            env:
              PGHOST: gotify-cnpg-rw
              PGUSER:
                valueFrom:
                  secretKeyRef:
                    name: gotify-custom-cnpg-user
                    key: username
              PGPASSWORD:
                valueFrom:
                  secretKeyRef:
                    name: gotify-custom-cnpg-user
                    key: password
              PGDATABASE: gotify
            command: [/bin/sh, -c]
            args:
              - |
                echo "Testing connection for DB $PGDATABASE on $PGHOST"
                until
                  pg_isready
                  do sleep 5
                done
                echo "DB $PGDATABASE available on $PGHOST"
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                  - ALL

    service:
      gotify:
        controller: gotify
        primary: true
        ports:
          http:
            primary: true
            port: 80
            targetPort: *port_http

    ingress:
      gotify:
        annotations:
          traefik.ingress.kubernetes.io/router.tls: "true"
          traefik.ingress.kubernetes.io/router.entrypoints: websecure
          # TODO hardcoding the namespace until a solutions is found on how to do this with replacements
          traefik.ingress.kubernetes.io/router.middlewares: gotify-chain-country-whitelist@kubernetescrd
        hosts:
          - host: &host gotify.vonarx.online
            paths:
              - path: /
                service:
                  identifier: gotify
                  port: http
        tls:
          - hosts:
              - *host
            secretName: wildcard-vonarx-online-cert

    persistence:
      data:
        type: persistentVolumeClaim
        accessMode: ReadWriteMany
        retain: true
        size: &pvc_config_size 1Gi
        #dataSourceRef:
        #  apiGroup: volsync.backube
        #  kind: ReplicationDestination
        #  name: gotify-dest-data

    rawResources:
      dest-data:
        enabled: false
        apiVersion: volsync.backube/v1alpha1
        kind: ReplicationDestination
        spec:
          spec:
            trigger:
              manual: restore-once
            restic:
              repository: gotify-restic-data
              accessModes: [ReadWriteMany]
              capacity: *pvc_config_size
              copyMethod: Snapshot
              moverSecurityContext:
                runAsUser: *PUID
                fsGroup: *GUID
                runAsGroup: *GUID
              storageClassName: longhorn
              volumeSnapshotClassName: longhorn

      source-data:
        enabled: false
        apiVersion: volsync.backube/v1alpha1
        kind: ReplicationSource
        spec:
          spec:
            sourcePVC: gotify-data
            trigger:
              schedule: "@daily"
            restic:
              repository: gotify-restic-data
              pruneIntervalDays: 7
              retain:
                daily: 7
                weekly: 4
              copyMethod: Clone
              storageClassName: longhorn-local-lax
              cacheStorageClassName: longhorn
              moverSecurityContext:
                runAsUser: *PUID
                fsGroup: *GUID
                runAsGroup: *GUID

      cnpg:
        apiVersion: postgresql.cnpg.io/v1
        kind: Cluster
        spec:
          spec:
            description: PostgreSQL Cluster for gotify
            instances: 3

            imageCatalogRef:
              apiGroup: postgresql.cnpg.io
              kind: ClusterImageCatalog
              name: postgresql-standard-trixie
              major: 18

            storage:
              size: 1Gi
              storageClass: longhorn-local-strict

            walStorage:
              size: 1Gi
              storageClass: longhorn-local-strict

            bootstrap:
              initdb:
                database: gotify
                owner: gotify
                secret:
                  name: gotify-custom-cnpg-user

            affinity:
              enablePodAntiAffinity: true
              podAntiAffinityType: required

---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gotify-alertmanager-bridge
spec:
  interval: 30m
  chart:
    spec:
      chart: app-template
      version: 4.6.2
      interval: 30m
      sourceRef:
        kind: HelmRepository
        name: bjw-s

  values:
    global:
      alwaysAppendIdentifierToResourceName: true

    defaultPodOptions:
      securityContext:
        runAsUser: &PUID 568
        runAsGroup: &GUID 568
        runAsNonRoot: true
        fsGroup: *GUID
        fsGroupChangePolicy: OnRootMismatch
        seccompProfile:
          type: RuntimeDefault

    controllers:
      gotify-alertmanager-bridge:
        type: deployment

        containers:
          bridge:
            image:
              repository: ghcr.io/druggeri/alertmanager_gotify_bridge
              tag: 2.3.2@sha256:242441023c6a7956fc7bcdd30350a8fed38f791e703d670aa286fc0465f88b41
            env:
              GOTIFY_ENDPOINT: http://gotify/message
              PORT: &port_http 8080
              WEBHOOK_PATH: &webhook_bridge /webhook
              PRIORITY_ANNOTATION: severity
            envFrom:
              - secretRef:
                  name: gotify-alertmanager-bridge-default-token
            probes:
              liveness:
                enabled: true
                port: *port_http
                spec:
                  failureThreshold: 6
              readiness:
                enabled: true
                port: *port_http
              startup:
                enabled: true
                port: *port_http
                spec:
                  failureThreshold: 30
                  periodSeconds: 5
            resources:
              requests:
                cpu: 50m
                memory: 1Gi
              limits:
                memory: 2Gi
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                  - ALL

    service:
      gotify-alertmanager-bridge:
        controller: gotify-alertmanager-bridge
        primary: true
        ports:
          http:
            primary: true
            port: 80
            targetPort: *port_http

    rawResources:
      alertmanager-config:
        apiVersion: monitoring.coreos.com/v1alpha1
        kind: AlertmanagerConfig
        spec:
          spec:
            route:
              receiver: gotify-joker9944
              groupBy:
                - namespace
                - alertname
                - severity
              groupWait: 30s
              groupInterval: 5m
              repeatInterval: 3h

            receivers:
              - name: gotify-joker9944
                sendResolved: false
                webhookConfigs:
                  - urlSecret:
                      name: alertmanager-gotify-joker9944
                      key: url
