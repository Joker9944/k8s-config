apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: traefik
  namespace: ${main_namespace}
spec:
  interval: 5m
  chart:
    spec:
      chart: traefik
      version: 33.1.0
      sourceRef:
        kind: HelmRepository
        name: traefik
        namespace: flux-system
      interval: 5m

  install:
    crds: CreateReplace
    remediation:
      retries: 3

  upgrade:
    crds: CreateReplace
    remediation:
      retries: 3

  values:

    deployment:
      # Switched to DaemonSet since it allows node local routing with externalTrafficPolicy set to Local
      kind: DaemonSet

    ingressClass:
      enabled: false

    experimental:
      # TODO Implement bouncer
      plugins:
        geoblock:
          moduleName: github.com/PascalMinder/geoblock
          # renovate: datasource=github-tags depName=geoblock-traefik-plugin packageName=PascalMinder/geoblock versioning=semver-coerced
          version: v0.2.8

    providers:
      kubernetesCRD:
        allowCrossNamespace: true

    volumes:
      # Mount cluster interal root ca for self signed certs
      - name: cluster-root-ca-cert
        mountPath: /certs/cluster-root-ca
        type: secret

    logs:
      general:
        format:  json
      access:
        enabled: true
        format:  json

    tlsStore:
        default:
          defaultCertificate:
            secretName: wildcard-vonarx-online

    service:
      annotations:
        metallb.universe.tf/loadBalancerIPs: 192.168.178.210
      spec:
        externalTrafficPolicy: Local

    ports:
      # DNS over TCP
      dot:
        port: 8853
        expose:
          default: true
        exposedPort: 853
        protocol: TCP
      # Satisfactory dedicated server
      dss-tcp:
        port: 7777
        expose:
          default: true
        exposedPort: 7777
        protocol: TCP
      # Satisfactory dedicated server
      dss-udp:
        port: 7777
        expose:
          default: true
        exposedPort: 7777
        protocol: UDP

    extraObjects:
      - |
        apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: traefik-dashboard
          namespace: ${main_namespace}
          labels:
            app.kubernetes.io/name: traefik
            app.kubernetes.io/instance: traefik-ingress-system
          annotations:
            traefik.ingress.kubernetes.io/router.tls: 'true'
            traefik.ingress.kubernetes.io/router.entrypoints: websecure
            traefik.ingress.kubernetes.io/router.middlewares: ingress-system-chain-basic@kubernetescrd,ingress-system-local-link-whitelist@kubernetescrd
        spec:
          rules:
          - host: traefik.vonarx.online
            http:
              paths:
              - pathType: Prefix
                path: "/dashboard"
                backend:
                  service:
                    name: traefik
                    port: 
                      number: 7777
