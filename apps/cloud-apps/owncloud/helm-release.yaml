apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: ocis
  namespace: ${main_namespace}
spec:
  interval: 30m
  chart:
    spec:
      chart: charts/ocis
      sourceRef:
        kind: GitRepository
        name: ocis-charts
        namespace: flux-system
      interval: 30m

  valuesFrom:
    - kind: ConfigMap
      name: ocis-ingress-values
    - kind: ConfigMap
      name: ocis-oidc-values
    - kind: ConfigMap
      name: ocis-persistence-values

  postRenderers:
    - kustomize:
        patches:
          - patch: |-
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: users
                namespace: ${main_namespace}
              spec:
                template:
                  spec:
                    containers:
                      - name: users
                        env:
                          - name: USERS_LDAP_CACERT
                            value: /etc/ocis/ldap-ca/ca.crt
          - patch: |-
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: groups
                namespace: ${main_namespace}
              spec:
                template:
                  spec:
                    containers:
                      - name: groups
                        env:
                          - name: GROUPS_LDAP_CACERT
                            value: /etc/ocis/ldap-ca/ca.crt
          - patch: |-
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: graph
                namespace: ${main_namespace}
              spec:
                template:
                  spec:
                    containers:
                      - name: graph
                        env:
                          - name: GRAPH_LDAP_CACERT
                            value: /etc/ocis/ldap-ca/ca.crt
                    volumes:
                      - name: ldap-ca
                        emptyDir: null
                        secret:
                          secretName: wildcard-${main_namespace}-cert
          # This is a hack to use NFS storage instead of a PVC for user data
          # TODO Use standard ways after https://github.com/owncloud/ocis-charts/issues/722
          - patch: |-
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: storageusers
                namespace: ${main_namespace}
              spec:
                template:
                  spec:
                    containers:
                      - name: storageusers
                        securityContext:
                          runAsUser: 6010
                          runAsGroup: 6001
                          fsGroup: 6001
                    volumes:
                      - name: storageusers-data
                        persistentVolumeClaim: null
                        nfs:
                          server: 192.168.178.14
                          path: /mnt/chronos/cloud-data
