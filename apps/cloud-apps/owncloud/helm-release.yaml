apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: ocis
  namespace: ${main_namespace}
spec:
  interval: 30m
  chart:
    spec:
      chart: charts/ocis
      sourceRef:
        kind: GitRepository
        name: ocis-charts
        namespace: flux-system
      interval: 30m

  valuesFrom:
    - kind: ConfigMap
      name: ocis-ingress-values
      namespace: flux-system
    - kind: ConfigMap
      name: ocis-oidc-values
      namespace: flux-system

  postRenderers:
    - kustomize:
        patches:
          - patch: |-
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: users
                namespace: ${main_namespace}
              spec:
                template:
                  spec:
                    containers:
                      - name: users
                        env:
                          - name: USERS_LDAP_CACERT
                            value: /etc/ocis/ldap-ca/ca.crt
          - patch: |-
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: groups
                namespace: ${main_namespace}
              spec:
                template:
                  spec:
                    containers:
                      - name: groups
                        env:
                          - name: GROUPS_LDAP_CACERT
                            value: /etc/ocis/ldap-ca/ca.crt
          - patch: |-
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: graph
                namespace: ${main_namespace}
              spec:
                template:
                  spec:
                    containers:
                      - name: graph
                        env:
                          - name: GRAPH_LDAP_CACERT
                            value: /etc/ocis/ldap-ca/ca.crt
                    volumes:
                      - name: ldap-ca
                        emptyDir: null
                        secret:
                          secretName: wildcard-${main_namespace}-cert
